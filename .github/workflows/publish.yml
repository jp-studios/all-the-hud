# Automatically publish to Modrinth and CurseForge when a GitHub release is published
# Also syncs README to Modrinth when it changes
name: publish

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'README.md'

env:
  MINECRAFT_VERSIONS_1_20: "1.20.1"
  MINECRAFT_VERSIONS_1_21: "1.21.1"
  JAVA_VERSION: 21

jobs:
  # Sync README to Modrinth when it changes
  sync-readme:
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync README to Modrinth
        run: |
          # Read README content
          BODY=$(cat README.md)

          # Update Modrinth project description via API
          curl -X PATCH "https://api.modrinth.com/v2/project/${{ secrets.MODRINTH_PROJECT_ID }}" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$BODY" '{body: $body}')"

          echo "README synced to Modrinth"

  # Build and publish on release
  build-and-publish:
    if: github.event_name == 'release'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'microsoft'

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      # Build 1.21.1 version
      - name: Build 1.21.1
        run: ./gradlew clean build

      - name: Rename 1.21.1 JAR
        run: |
          VERSION=$(grep 'mod_version=' gradle.properties | cut -d'=' -f2)
          mv build/libs/allthehud-${VERSION}.jar build/libs/allthehud-${VERSION}-1.21.1-alpha.jar

      - name: Upload 1.21.1 JAR
        uses: actions/upload-artifact@v4
        with:
          name: allthehud-1.21.1
          path: build/libs/*-1.21.1-alpha.jar

      # Build 1.20.1 version
      - name: Setup for 1.20.1 build
        run: |
          cp gradle.properties gradle.properties.bak
          cp gradle-1.20.1.properties gradle.properties
          # Patch HudRenderer for 1.20.1 API compatibility
          sed -i 's/RenderTickCounter tickCounter/float tickDelta/g' src/client/java/com/jpstudios/allthehud/HudRenderer.java
          sed -i 's/Identifier\.of(/new Identifier(/g' src/client/java/com/jpstudios/allthehud/HudRenderer.java

      - name: Setup JDK 17 for 1.20.1
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'microsoft'

      - name: Build 1.20.1
        run: ./gradlew clean build

      - name: Rename 1.20.1 JAR
        run: |
          VERSION=$(grep 'mod_version=' gradle.properties | cut -d'=' -f2)
          mv build/libs/allthehud-${VERSION}.jar build/libs/allthehud-${VERSION}-1.20.1-alpha.jar

      - name: Upload 1.20.1 JAR
        uses: actions/upload-artifact@v4
        with:
          name: allthehud-1.20.1
          path: build/libs/*-1.20.1-alpha.jar

      # Publish 1.21.1 to Modrinth and CurseForge
      - name: Download 1.21.1 artifact
        uses: actions/download-artifact@v4
        with:
          name: allthehud-1.21.1
          path: publish/1.21.1

      - name: Publish 1.21.1
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          files: publish/1.21.1/*.jar
          name: ${{ github.event.release.name }}
          version: ${{ github.event.release.tag_name }}
          version-type: alpha
          changelog: ${{ github.event.release.body }}
          loaders: fabric
          game-versions: ${{ env.MINECRAFT_VERSIONS_1_21 }}
          dependencies: |
            fabric-api(required)
            modmenu(optional)

      # Publish 1.20.1 to Modrinth and CurseForge
      - name: Download 1.20.1 artifact
        uses: actions/download-artifact@v4
        with:
          name: allthehud-1.20.1
          path: publish/1.20.1

      - name: Publish 1.20.1
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          files: publish/1.20.1/*.jar
          name: "${{ github.event.release.name }} (1.20.1)"
          version: "${{ github.event.release.tag_name }}-1.20.1"
          version-type: alpha
          changelog: ${{ github.event.release.body }}
          loaders: fabric
          game-versions: ${{ env.MINECRAFT_VERSIONS_1_20 }}
          dependencies: |
            fabric-api(required)
            modmenu(optional)

      # Sync README to Modrinth after publishing
      - name: Sync README to Modrinth
        run: |
          BODY=$(cat README.md)
          curl -X PATCH "https://api.modrinth.com/v2/project/${{ secrets.MODRINTH_PROJECT_ID }}" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$BODY" '{body: $body}')"
          echo "README synced to Modrinth"
